<!DOCTYPE html>
{% extends 'base.html' %} {% block content %}
<div style="max-width: 700px; margin: 30px auto; padding: 20px">
  <h1>ğŸ® {{ game.room_name }}</h1>
  <p>Creador: {{ game.owner.username }}</p>
  <p>TÃº: {{ user.username }}</p>

  {% if game.player2 %}
  <p>Jugador 2: {{ game.player2.username }}</p>
  {% else %}
  <p>Jugador 2: Esperando jugador...</p>
  {% endif %}

  <p>
    Jugador 1 (âŒ): {{ game.owner.username }}<br />
    {% if game.player2 %} Jugador 2 (â­•): {{ game.player2.username }}
    <!---->
    {% endif%}
    <!---->
  </p>

  {% if game.game_state == 'active' %}
  <p id="turn-message">Turno del Jugador {{ game.active_player }}</p>
  {% elif game.game_state == 'won' %}
  <p>ğŸ† Â¡GanÃ³ el Jugador {{ game.winner }}!</p>
  {% else %}
  <p>ğŸ¤ Â¡Es un empate!</p>
  {% endif %}

  <!-- Tablero -->
  <div style="margin: 30px 0">
    <div
      style="display: grid; grid-template-columns: repeat(3, 80px); gap: 5px"
      id="game-board"
    >
      {% for i in "012345678" %}
      <div
        id="cell-{{ forloop.counter0 }}"
        class="game-cell"
        data-position="{{ forloop.counter0 }}"
        style="
          width: 80px;
          height: 80px;
          font-size: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: white;
          border: 2px solid #4caf50;
          border-radius: 8px;
          cursor: pointer;
          transition: background-color 0.3s;
        "
      >
        {% with idx=forloop.counter0 %}
        <!---->
        {% if game.board|slice:idx|slice:"-1" == 'X' %}âŒ
        <!---->
        {% elif game.board|slice:idx|slice:"-1" == 'O' %}â­•
        <!---->
        {% else%}â¬œ {% endif %} {% endwith %}
        <!---->
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Botones de acciÃ³n -->
  <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap">
    <a
      href="{% url 'games:game_list' %}"
      style="
        display: inline-block;
        padding: 12px 24px;
        background-color: #6c757d;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
      "
      onmouseover="this.style.backgroundColor='#5a6268'"
      onmouseout="this.style.backgroundColor='#6c757d'"
    >
      â†© Volver a Juegos
    </a>

    {% if game.game_state != 'active' and user == game.owner %}
    <form
      method="POST"
      action="{% url 'games:delete_game' game.id %}"
      style="display: inline; margin: 0"
    >
      {% csrf_token %}
      <button
        type="submit"
        style="
          padding: 12px 24px;
          background-color: #dc3545;
          color: white;
          font-weight: 500;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          transition: background-color 0.3s;
        "
        onmouseover="this.style.backgroundColor='#c82333'"
        onmouseout="this.style.backgroundColor='#dc3545'"
      >
        ğŸ—‘ï¸ Eliminar Juego
      </button>
    </form>
    {% endif %}

    <button
      onclick="location.reload()"
      style="
        padding: 12px 24px;
        background-color: #17a2b8;
        color: white;
        font-weight: 500;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s;
      "
      onmouseover="this.style.backgroundColor='#138496'"
      onmouseout="this.style.backgroundColor='#17a2b8'"
    >
      ğŸ”„ Actualizar
    </button>
  </div>

  <!-- Estado WebSocket -->
  <div
    id="socket-status"
    style="
      margin-top: 30px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #4caf50;
    "
  >
    <p style="margin: 0; color: #495057; font-size: 14px">
      <strong>ConexiÃ³n WebSocket:</strong>
      <span id="connection-status">Conectando...</span>
    </p>
  </div>
</div>

<style>
  .game-cell:hover {
    background-color: #e8f5e9 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
</style>

<!-- Script WebSocket simplificado -->
<script>
  const roomId = "{{ game.room_name }}";
  const userId = "{{ user.id }}";

  console.log("Conectando a sala:", roomId);

  // Crear conexiÃ³n WebSocket
  const gameSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/game/" + roomId + "/"
  );
  const connectionStatus = document.getElementById("connection-status");

  gameSocket.onopen = function (e) {
    console.log("âœ… Conectado al socket");
    connectionStatus.textContent = "âœ… Conectado";
    connectionStatus.style.color = "#28a745";
  };

  gameSocket.onerror = function (e) {
    console.error("âŒ Error en WebSocket");
    connectionStatus.textContent = "âŒ Error de conexiÃ³n";
    connectionStatus.style.color = "#dc3545";
  };

  gameSocket.onclose = function (e) {
    console.log("ğŸ”Œ ConexiÃ³n cerrada");
    connectionStatus.textContent = "âŒ Desconectado";
    connectionStatus.style.color = "#dc3545";
  };

  gameSocket.onmessage = function (e) {
    console.log("ğŸ“¨ Mensaje recibido:", e.data);
    const data = JSON.parse(e.data).my_data;

    // Mostrar error si hay
    if (data.error) {
      alert("Error: " + data.error);
      return;
    }

    // Actualizar tablero
    if (data.board) {
      data.board.forEach((cell, index) => {
        const cellElement = document.getElementById(`cell-${index}`);
        if (cellElement) {
          cellElement.innerHTML =
            cell === " " ? "â¬œ" : cell === "X" ? "âŒ" : "â­•";
        }
      });
    }

    // Actualizar mensaje de turno
    const turnMessage = document.getElementById("turn-message");
    if (turnMessage && data.game_state === "active") {
      turnMessage.innerHTML = "Turno del Jugador " + data.active_player;
    }

    // Mostrar ganador/empate
    if (data.game_state === "won") {
      turnMessage.innerHTML = "ğŸ† Â¡GanÃ³ el Jugador " + data.winner + "!";
    } else if (data.game_state === "tie") {
      turnMessage.innerHTML = "ğŸ¤ Â¡Es un empate!";
    }
  };

  // Manejar clics en las celdas
  document.addEventListener("DOMContentLoaded", function () {
    const cells = document.querySelectorAll(".game-cell");
    cells.forEach((cell) => {
      cell.addEventListener("click", function () {
        if (gameSocket.readyState !== WebSocket.OPEN) {
          alert("No hay conexiÃ³n WebSocket. Recarga la pÃ¡gina.");
          return;
        }

        const position = parseInt(this.dataset.position);
        console.log("Enviando movimiento a posiciÃ³n:", position);

        gameSocket.send(
          JSON.stringify({
            position: position,
          })
        );
      });
    });
  });
</script>

{% endblock %}
